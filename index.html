<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Отчет по складу</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 20px;
            color: #000;
            -webkit-tap-highlight-color: transparent; /* Убирает синюю подсветку на Android */
        }

        /* Поле даты */
        .date-container {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }
        input[type="date"] {
            font-size: 18px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 12px;
            background: #f9f9f9;
            font-weight: bold;
            color: #333;
            width: 100%;
            max-width: 300px;
            text-align: center;
        }

        /* Список товаров */
        .item-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            justify-content: space-between;
        }

        /* Кнопка товара */
        .item-btn {
            flex-grow: 1;
            background-color: #f0f0f0; /* Серый фон */
            color: #333;
            border: none;
            padding: 15px 10px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 800; /* Жирный шрифт */
            text-align: left; /* Текст слева */
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .item-btn.active {
            background-color: #007bff; /* Синий активный */
            color: white;
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.3);
        }

        /* Поле ввода количества */
        .qty-input {
            width: 0; /* Скрыто по умолчанию */
            opacity: 0;
            padding: 0;
            margin-left: 0;
            border: none;
            overflow: hidden;
            transition: all 0.3s ease;
            background: white;
            border-bottom: 2px solid #007bff;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
            color: #333;
            border-radius: 0;
            outline: none;
        }

        /* Когда товар активен, показываем инпут */
        .item-row.active .qty-input {
            width: 70px;
            opacity: 1;
            padding: 10px 5px;
            margin-left: 10px; /* Отступ справа от кнопки */
        }

        /* Главная кнопка отправки */
        .main-btn {
            width: 100%;
            padding: 18px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 30px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .main-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        /* Состояния загрузки и успеха */
        #loading, #success-screen {
            display: none;
            text-align: center;
            margin-top: 50px;
        }
        .checkmark {
            font-size: 60px;
            color: #28a745;
        }
    </style>
</head>
<body>

<div id="app">
    <!-- Выбор даты -->
    <div class="date-container">
        <input type="date" id="report-date">
    </div>

    <!-- Список кнопок -->
    <div id="items-list">
        <!-- Кнопки генерируются JS, но структура такая:
        <div class="item-row">
            <button class="item-btn">Название</button>
            <input type="number" class="qty-input">
        </div>
        -->
    </div>

    <button class="main-btn" onclick="sendData()" id="send-btn">Отправить отчет</button>
</div>

<!-- Экраны состояния -->
<div id="loading">⏳ Отправка данных...</div>
<div id="success-screen">
    <div class="checkmark">✅</div>
    <h2>Отчет отправлен!</h2>
    <p>Данные в таблице и в чате.</p>
    <button class="main-btn" onclick="Telegram.WebApp.close()">Закрыть</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); // Раскрыть на весь экран

    // ВСТАВЬ СЮДА URL ИЗ DEPLOY В GOOGLE APPS SCRIPT
    const SCRIPT_URL = "https://script.google.com/macros/s/ВАШ_ДЛИННЫЙ_ID/exec";

    // Конфигурация полей (key должен совпадать с именами в Google Script)
    const ITEMS = [
        { key: "controller", label: "Контроллер" },
        { key: "tracker", label: "Трекер" },
        { key: "motor", label: "Мотор-колесо" },
        { key: "battery", label: "АКБ" },
        { key: "lock", label: "Замок" },
        { key: "dashboard", label: "Дашборд" },
        { key: "handle", label: "Ручка тормоза" }
    ];

    // Инициализация
    const listContainer = document.getElementById('items-list');
    const dateInput = document.getElementById('report-date');
    dateInput.valueAsDate = new Date(); // Установить сегодняшнюю дату

    // Генерация кнопок
    ITEMS.forEach(item => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.id = `row-${item.key}`;

        // Кнопка
        const btn = document.createElement('button');
        btn.className = 'item-btn';
        btn.innerText = item.label;
        btn.onclick = () => toggleItem(item.key);

        // Инпут
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'qty-input';
        input.id = `input-${item.key}`;
        input.min = "1";
        input.placeholder = "Кол-во";
        // Валидация: не даем ввести минус или 0 вручную через клавиатуру
        input.oninput = function() {
            if(this.value < 1 && this.value !== "") this.value = "";
        };

        row.appendChild(btn);
        row.appendChild(input);
        listContainer.appendChild(row);
    });

    // Логика переключения
    function toggleItem(key) {
        const row = document.getElementById(`row-${key}`);
        const btn = row.querySelector('.item-btn');
        const input = row.querySelector('.qty-input');
        
        const isActive = btn.classList.contains('active');

        if (isActive) {
            // Отключаем
            btn.classList.remove('active');
            row.classList.remove('active');
            input.value = ""; // Очищаем значение
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        } else {
            // Включаем
            btn.classList.add('active');
            row.classList.add('active');
            input.value = "1"; // Дефолтное значение
            input.focus(); // Сразу фокус на ввод
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }
    }

    function sendData() {
        // Собираем данные
        const rawDate = dateInput.value;
        const resultItems = {};
        
        // Переделываем формат даты из YYYY-MM-DD в DD.MM.YYYY
        const [year, month, day] = rawDate.split('-');
        const formattedDate = `${day}.${month}.${year}`;

        ITEMS.forEach(item => {
            const input = document.getElementById(`input-${item.key}`);
            const row = document.getElementById(`row-${item.key}`);
            // Если строка активна и введено значение
            if (row.classList.contains('active') && input.value) {
                resultItems[item.key] = parseInt(input.value);
            }
        });

        // Данные пользователя Telegram
        const user = tg.initDataUnsafe.user || { first_name: "Неизвестный", id: 0 };
        // Определяем Chat ID (если приложение открыто в группе, он будет в initDataUnsafe.chat)
        // Если открыто в личке, берем user.id
        const chatId = '-1003850354146';
        // Формируем имя
        let fullName = user.first_name;
        if (user.last_name) fullName += " " + user.last_name;
        if (user.username) fullName += " (@" + user.username + ")";

        const payload = {
            date: formattedDate,
            items: resultItems,
            username: fullName,
            userId: user.id,
            chatId: chatId // Важно для отправки сообщения в группу
        };

        // UI отправки
        document.getElementById('app').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success-screen').style.display = 'block';
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }).catch(err => {
            alert("Ошибка: " + err);
            document.getElementById('app').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        });
    }
</script>

</body>
</html>
